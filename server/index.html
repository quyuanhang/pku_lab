<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Visualization of Nobel Prizes</title>
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
    <style>
    </style>

</head>

<body>
    <div class="navbar navbar-default navbar-fixed-top">
        <!-- 标题容器 -->
        <div class="navbar-header">
            <a class="navbar-brand" href="#">
                <b>Visualization of Nobel Prizes</b>
            </a>
        </div>
        <div class="container"></div>
    </div>
    <div id='sankey_table'>
        <!-- 流量图 -->
        <svg id="sankey"></svg>
    </div>
    <div id='legend' class="row">
        <svg id='legend_svg' class="col-xs-7"></svg>
        <!-- 流量图例 -->
        <div class="ref col-xs-5">
            <!-- 条形图下拉 -->
            <div class="btn-group">
                <button type="button" class="btn btn-default">Category</button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                    <span class="sr-only">切换下拉菜单</span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="javascript:filter([[1,2], null, null, null])">Chemistry(1)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([[2,3], null, null, null])">Economics(2)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([[3,4], null, null, null])">Literature(3)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([[4,5], null, null, null])">Medicine(4)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([[5,6], null, null, null])">Peace(5)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([[6,7], null, null, null])">Physics(6)</a>
                    </li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default">Institution Country</button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                    <span class="sr-only">切换下拉菜单</span>
                </button>
                <ul class="dropdown-menu row pre-scrollable" role="menu">
                    <li>
                        <a href="javascript:filter([null, null, [0,1], null])">Ireland(0)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [1,2], null])">India(1)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [2,3], null])">Alsace (then Germany, now France)(2)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [3,4], null])">Spain(3)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [4,5], null])">Finland(4)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [5,6], null])">Hungary(5)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [6,7], null])">Czechoslovakia(6)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [7,8], null])">Argentina(7)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [8,9], null])">China(8)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [9,10], null])">Portugal(9)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [10,11], null])">Russia(10)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [11,12], null])">Norway(11)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [12,13], null])">Israel(12)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [13,14], null])">Italy(13)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [14,15], null])">Austria(14)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [15,16], null])">Belgium(15)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [16,17], null])">Australia(16)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [17,18], null])">Canada(17)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [18,19], null])">Denmark(18)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [19,20], null])">USSR(19)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [20,21], null])">the Netherlands(20)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [21,22], null])">Sweden(21)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [22,23], null])">Japan(22)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [23,24], null])">Switzerland(23)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [24,25], null])">Federal Republic of Germany(24)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [25,26], null])">France(25)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [26,27], null])">Germany(26)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [27,28], null])">United Kingdom(27)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [28,29], null])">USA(28)</a>
                    </li>
                    <li>
                        <a href="javascript:filter([null, null, [29,30], null])">Unkown(29)</a>
                    </li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default">Year</button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                    <span class="sr-only">切换下拉菜单</span>
                </button>
                <ul class="dropdown-menu row pre-scrollable" role="menu">
                    <li>
                        <a href="javascript:year_filter(1901)">1901</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1902)">1902</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1903)">1903</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1904)">1904</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1905)">1905</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1906)">1906</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1907)">1907</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1908)">1908</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1909)">1909</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1910)">1910</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1911)">1911</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1912)">1912</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1913)">1913</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1914)">1914</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1915)">1915</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1916)">1916</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1917)">1917</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1918)">1918</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1919)">1919</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1920)">1920</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1921)">1921</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1922)">1922</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1923)">1923</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1924)">1924</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1925)">1925</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1926)">1926</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1927)">1927</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1928)">1928</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1929)">1929</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1930)">1930</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1931)">1931</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1932)">1932</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1933)">1933</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1934)">1934</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1935)">1935</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1936)">1936</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1937)">1937</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1938)">1938</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1939)">1939</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1940)">1940</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1941)">1941</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1942)">1942</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1943)">1943</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1944)">1944</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1945)">1945</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1946)">1946</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1947)">1947</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1948)">1948</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1949)">1949</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1950)">1950</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1951)">1951</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1952)">1952</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1953)">1953</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1954)">1954</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1955)">1955</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1956)">1956</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1957)">1957</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1958)">1958</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1959)">1959</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1960)">1960</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1961)">1961</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1962)">1962</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1963)">1963</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1964)">1964</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1965)">1965</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1966)">1966</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1967)">1967</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1968)">1968</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1969)">1969</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1970)">1970</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1971)">1971</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1972)">1972</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1973)">1973</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1974)">1974</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1975)">1975</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1976)">1976</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1977)">1977</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1978)">1978</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1979)">1979</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1980)">1980</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1981)">1981</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1982)">1982</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1983)">1983</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1984)">1984</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1985)">1985</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1986)">1986</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1987)">1987</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1988)">1988</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1989)">1989</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1990)">1990</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1991)">1991</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1992)">1992</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1993)">1993</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1994)">1994</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1995)">1995</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1996)">1996</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1997)">1997</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1998)">1998</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(1999)">1999</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2000)">2000</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2001)">2001</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2002)">2002</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2003)">2003</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2004)">2004</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2005)">2005</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2006)">2006</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2007)">2007</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2008)">2008</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2009)">2009</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2010)">2010</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2011)">2011</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2012)">2012</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2013)">2013</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2014)">2014</a>
                    </li>
                    <li>
                        <a href="javascript:year_filter(2015)">2015</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 地图复选 -->
        <div class="col-xs-1">
            <form name="cat_form" action="" method="post">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Chemistry' value="Chemistry">Chemistry</label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Economics' value="Economics">Economics</label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Literature' value="Literature">Literature</label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Medicine' value="Medicine">Medicine</label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Peace' value="Peace">Peace</label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name='Physics' value="Physics">Physics</label>
                </div>
                <button type="button" class="btn btn-default" onclick="catfun()">distribution</button>
                <button type='button' id='mig_button' class="btn btn-default" onclick='linefun()' style="color: black">migration</button>
            </form>
        </div>
        <div id='map_table' class="col-xs-4">
            <!-- 地图 -->
            <svg id='map'>
                <!-- <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:rgb(38, 0, 255);stop-opacity:1" />
                    <stop offset="100%" style="stop-color:rgb(255, 251, 0);stop-opacity:1" />
                </linearGradient> -->
            </svg>
        </div>
        <div id="charts" class="col-xs-7">
            <!-- 条形图 -->
            <div id="category-chart" class="chart">
                <div class="title">Category</div>
            </div>
            <div id="age-chart" class="chart">
                <div class="title">&nbsp&nbspAge of Award</div>
            </div>
            <div id="country-chart" class="chart">
                <div class="title">Institution Country</div>
            </div>
            <div id="year-chart" class="chart">
                <div class="title">Year</div>
            </div>
            <aside id="totals">
                <span id="active">-</span> of
                <span id="total">-</span> records selected.</aside>
        </div>
    </div>

    <div class="panel-group" id="accordion">
        <!-- 数据表 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <button type="button" class="btn btn-default" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                        Detail List
                    </button>
                    <span style="font-size: small; margin-left: 10px;">(latest 30)</span>
                </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse">
                <div class="panel-body">
                    <div id="lists">
                        <div id="nobel-list" class="list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="src/jquery-3.2.1.min.js"></script>
    <script src="src/d3.js" charset="utf-8"></script>
    <script src="src/sankey.js"></script>
    <script src="src/crossfilter.v1.min.js"></script>
    <script src="src/bootstrap.js"></script>

    <script>
        d3.json("data/nobel_.json", function (err, data) {

            window.color = d3.scale.category20();
            var country_color = d3.scale.category20c();

            // var body = d3.select("body");

            var margin = { top: 10, right: 10, bottom: 10, left: 10 },
                height = $('#sankey_table').get(0).clientHeight - margin.top - margin.bottom,
                width = height * 60;
            // console.log(height, width)

            var svg = d3.select("body").select("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            // 定义桑基布局
            var sankey = d3.sankey()
                .nodeWidth(height / 10)
                .nodePadding(height / 15)
                .size([width - 30, height - 30])
                .nodes(data.nodes)
                .links(data.links)
                .layout();

            // 路径数据生成器
            var path = sankey.link();
            // console.log(path)

            // 绘制连接数据
            var links = svg.append("g").selectAll("path")
                .data(data.links)
                .enter()

            // console.log(links)

            // 绑定节点数据
            var nodes = svg.append("g").selectAll(".node")
                .data(data.nodes)
                .enter();

            // 绘制连接线
            links.append("path")
                // .attr('class', 'mypath')
                .attr({
                    'stroke-opacity': 0.05,
                    'fill': "none",
                    'stroke': function (d, i) { return color(d.category); },  //描边色
                    'd': path,  //路径数据
                    'id': function (d, i) { return 'link' + i }  //ID
                })
                .attr("stroke-width", function (d) {  //连线的宽度
                    return Math.max(1, d.dy);
                })
                .on("click", function (d) {
                    var last_cat = window.category;
                    window.category = d.category;
                    d3.select('#sankey').selectAll('path').attr("stroke-opacity", function (d_) {
                        var r = 0.05;
                        if ((window.category == d_.category) && (last_cat != window.category)) { r = 0.5 };
                        return r
                    });

                    // 操作条形图
                    var cat_num = { "Chemistry": 1, "Economics": 2, "Literature": 3, "Medicine": 4, "Peace": 5, "Physics": 6, 0: 7 };
                    var category = cat_num[d.category];
                    filter([[category, category + 1], null, null, null]);

                    var c = $('input[name=' + window.category + ']')[0];
                    if (c.checked === true) { c.checked = false }
                    else { c.checked = true }

                })

            window.tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");


            nodes.append("rect")
                .attr('x', function (d) { return d.x; })
                .attr('y', function (d) { return d.y; })
                .attr("width", function (d) { return d.dx; })
                .attr("height", function (d) { return d.dy; })
                // .style("fill", "tomato");
                .attr("fill", function (d) { return country_color(d.country) })
                .attr("opacity", 0.5)
                .attr('stroke-width', 2)
                .on("mouseover", function (d, i) {
                    d3.select(this).attr("opacity", 1);
                    tooltip.text(d.country)
                    tooltip.style("visibility", "visible");
                })
                .on("mouseout", function (d, i) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr("opacity", 0.5);
                    tooltip.style("visibility", "hidden");
                    // d3.select(this).text.attr('opacity', 0)
                })
                .on("click", function (d) {
                    var last_country = window.country;
                    window.country = d.country;
                    d3.select('#sankey').selectAll('rect').attr("stroke", function (d_) {
                        var r = null;
                        if ((window.country == d_.country) && (last_country != window.country)) { r = 'black' };
                        return r
                    });

                    // 操作条形图
                    // var country_num = { "Chemistry": 1,  "Economics": 2,  "Literature": 3,  "Medicine": 4,  "Peace": 5,  "Physics": 6, 0: 7 };
                    // var country = country_num[d.country];
                    // filter([null, null, [country, country + 1], null]);
                })
                .on("mousemove", function () { return tooltip.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px"); })

            // 绘制节点文本
            nodes.append("text")
                .attr({
                    y: function (d) { return d.y + d.dy; },
                    x: function (d) { return d.x + d.dx; },
                    "opacity": 0
                })
                .attr("font-size", height / 20)
                .text(function (d) { return d.country; })

            nodes.append("text")
                .attr("x", function (d) { return d.x })
                .attr("y", height - 15)
                // .attr("opacity", 0.1)
                .attr("font-size", height / 20)
                .text(function (d) { return d.year })
                .on('click', function (d, i) {
                    var year = d.year
                    //这里添加与时间有关的交互
                })

            legend(color)


        });

        function legend(color_scale) {
            var rwidth = 30,
                twidth = 70,
                inter = 15,
                height = 15
            side = 5;
            var dataset = ["Chemistry", "Economics", "Literature", "Medicine", "Peace", "Physics"];
            var svg = d3.select("#legend_svg")
                .attr('width', (rwidth + twidth + inter) * dataset.length + side * 2)
                .attr('height', height + side * 2);

            svg.selectAll('rect')
                .data(dataset)
                .enter()
                .append('rect')
                .attr("x", function (d, i) {
                    return (rwidth + twidth + inter) * i;
                })
                .attr("y", 5)
                .attr("width", rwidth)
                .attr("height", 15)
                .attr('opacity', 0.5)
                .attr('fill', function (d) { return color_scale(d) })
                .attr('stroke-width', 3)
                .on("click", function (d) {
                    var last_cat = window.category;
                    window.category = d;

                    // 操作图例
                    d3.select("#legend_svg")
                        .selectAll('rect')
                        .attr('stroke', function (d_) {
                            var s = null;
                            if ((window.category == d_) && (last_cat != window.category)) { s = 'black' };
                            return s;
                        })

                    // 操作流量图    
                    d3.select('#sankey').selectAll('path').attr("stroke-opacity", function (d_) {
                        var r = 0.05;
                        if ((window.category == d_.category) && (last_cat != window.category)) { r = 0.5 };
                        return r;
                    });

                    // 操作条形图
                    var cat_num = { "Chemistry": 1, "Economics": 2, "Literature": 3, "Medicine": 4, "Peace": 5, "Physics": 6, 0: 7 };
                    var category = cat_num[d];
                    filter([[category, category + 1], null, null, null]);

                    //操作表单
                    var c = $('input[name=' + window.category + ']')[0];
                    if (c.checked === true) { c.checked = false }
                    else { c.checked = true }

                })

            svg.selectAll('text')
                .data(dataset)
                .enter()
                .append('text')
                .attr('x', function (d, i) { return (rwidth + twidth + inter) * i + rwidth + side })
                .attr('y', side + height)
                .attr('height', height)
                .attr('width', twidth)
                .text(function (d) { return d })
        }


        d3.csv("data/data.csv", function (error, data) {

            var formatNumber = d3.format("d");

            var nestByYear = d3.nest()
                .key(function (d) { return d.year; });

            var nobel = crossfilter(data),
                all = nobel.groupAll(),
                year = nobel.dimension(function (d) { return d.year; }),
                years = year.group(function (d) { return d; }),
                age = nobel.dimension(function (d) { return d.age; }),
                ages = age.group(function (d) { return d; }),
                category = nobel.dimension(function (d) { return d.category; }),
                categories = category.group(function (d) { return d; }),
                country = nobel.dimension(function (d) { return Math.floor(d.country / 1); }),
                countries = country.group(function (d) { return d; });

            var charts = [

                barChart()
                    .dimension(category)
                    .group(categories)
                    .x(d3.scale.linear()
                        .domain([1, 7])
                        .rangeRound([0, 6 * 7])),

                barChart()
                    .dimension(age)
                    .group(ages)
                    .x(d3.scale.linear()
                        .domain([17, 91])
                        .rangeRound([0, 6 * 75])),

                barChart()
                    .dimension(country)
                    .group(countries)
                    .x(d3.scale.linear()
                        .domain([0, 30])
                        .rangeRound([0, 6 * 31])),

                barChart()
                    .dimension(year)
                    .group(years)
                    .x(d3.scale.linear()
                        .domain([1900, 2016])
                        .rangeRound([0, 6 * 118]))
                    .filter([1901, 1917])

            ];

            var chart = d3.selectAll(".chart")
                .data(charts)
                .each(function (chart) { chart.on("brush", renderAll).on("brushend", renderAll); });

            var list = d3.selectAll(".list")
                .data([nobelList]);

            d3.selectAll("#total")
                .text(formatNumber(nobel.size()));

            renderAll();

            function render(method) {
                d3.select(this).call(method);
            }

            function renderAll() {
                chart.each(render);
                list.each(render);
                d3.select("#active").text(formatNumber(all.value()));
            }

            window.filter = function (filters) {
                filters.forEach(function (d, i) { charts[i].filter(d); });
                renderAll();
            };

            window.reset = function (i) {
                charts[i].filter(null);
                renderAll();
            };

            function nobelList(div) {
                var nobelByYear = nestByYear.entries(year.top(30));

                div.each(function () {
                    var year = d3.select(this).selectAll(".year")
                        .data(nobelByYear, function (d) { return d.key; });

                    year.enter().append("div")
                        .attr("class", "year")
                        .append("div")
                        .attr("class", "y")
                        .text(function (d) { return d.values[0].year; });

                    year.exit().remove();

                    var nl = year.order().selectAll(".nl")
                        .data(function (d) { return d.values; }, function (d) { return d.id; });

                    var nobelEnter = nl.enter().append("div")
                        .attr("class", "nl");

                    nobelEnter.append("div")
                        .attr("class", "id")
                        .text(function (d) { return d.id; });

                    nobelEnter.append("div")
                        .attr("class", "name")
                        .text(function (d) { return d.firstname + " " + d.surname; });

                    nobelEnter.append("div")
                        .attr("class", "category")
                        .text(function (d) { return d.cate; });

                    nobelEnter.append("div")
                        .attr("class", "country")
                        .text(function (d) { return d.bornCountry; });

                    nobelEnter.append("div")
                        .attr("class", "gender")
                        .text(function (d) { return d.gender; });

                    nobelEnter.append("div")
                        .attr("class", "age")
                        .text(function (d) { return d.age; });

                    nobelEnter.append("div")
                        .attr("class", "country")
                        .text(function (d) { return d.coun; });

                    nobelEnter.append("div")
                        .attr("class", "motivation")
                        .text(function (d) { return d.motivation; });

                    nl.exit().remove();

                    nl.order();
                });
            }

            function barChart() {
                if (!barChart.id) barChart.id = 0;

                var margin = { top: 10, right: 10, bottom: 20, left: 10 },
                    x,
                    y = d3.scale.linear().range([100, 0]),
                    id = barChart.id++,
                    axis = d3.svg.axis().orient("bottom").ticks(7),
                    brush = d3.svg.brush(),
                    brushDirty,
                    dimension,
                    group,
                    round;

                function chart(div) {
                    var width = x.range()[1],
                        height = y.range()[0];

                    y.domain([0, group.top(1)[0].value]);

                    div.each(function () {
                        var div = d3.select(this),
                            g = div.select("g");

                        if (g.empty()) {
                            div.select(".title")
                                .append("br");

                            div.select(".title")
                                .append("a")
                                .attr("href", "javascript:reset(" + id + ");")
                                .attr("class", "reset")
                                .text("reset")
                                .style("display", "none");

                            g = div.append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                            g.append("clipPath")
                                .attr("id", "clip-" + id)
                                .append("rect")
                                .attr("width", width)
                                .attr("height", height);

                            g.selectAll(".bar")
                                .data(["background", "foreground"])
                                .enter().append("path")
                                .attr("class", function (d) { return d + " bar"; })
                                .datum(group.all());

                            g.selectAll(".foreground.bar")
                                .attr("clip-path", "url(#clip-" + id + ")");

                            g.append("g")
                                .attr("class", "axis")
                                .attr("transform", "translate(4," + height + ")")
                                .call(axis);

                            var gBrush = g.append("g").attr("class", "brush").call(brush);
                            gBrush.selectAll("rect").attr("height", height);
                            gBrush.selectAll(".resize").append("path").attr("d", resizePath);
                        }

                        if (brushDirty) {
                            brushDirty = false;
                            g.selectAll(".brush").call(brush);
                            div.select(".title a").style("display", brush.empty() ? "none" : null);
                            if (brush.empty()) {
                                g.selectAll("#clip-" + id + " rect")
                                    .attr("x", 0)
                                    .attr("width", width);
                            } else {
                                var extent = brush.extent();
                                g.selectAll("#clip-" + id + " rect")
                                    .attr("x", x(extent[0]))
                                    .attr("width", x(extent[1]) - x(extent[0]));
                            }
                        }

                        g.selectAll(".bar").attr("d", barPath);
                    });

                    function barPath(groups) {
                        var path = [],
                            i = -1,
                            n = groups.length,
                            d;
                        while (++i < n) {
                            d = groups[i];
                            path.push("M", x(d.key), ",", height, "V", y(d.value), "h5V", height);
                        }
                        return path.join("");
                    }

                    function resizePath(d) {
                        var e = +(d == "e"),
                            x = e ? 1 : -1,
                            y = height / 3;
                        return "M" + (.5 * x) + "," + y
                            + "A6,6 0 0 " + e + " " + (6.5 * x) + "," + (y + 6)
                            + "V" + (2 * y - 6)
                            + "A6,6 0 0 " + e + " " + (.5 * x) + "," + (2 * y)
                            + "Z"
                            + "M" + (2.5 * x) + "," + (y + 8)
                            + "V" + (2 * y - 8)
                            + "M" + (4.5 * x) + "," + (y + 8)
                            + "V" + (2 * y - 8);
                    }
                }

                brush.on("brushstart.chart", function () {
                    var div = d3.select(this.parentNode.parentNode.parentNode);
                    div.select(".title a").style("display", null);
                });

                brush.on("brush.chart", function () {
                    var g = d3.select(this.parentNode),
                        extent = brush.extent();
                    if (round) g.select(".brush")
                        .call(brush.extent(extent = extent.map(round)))
                        .selectAll(".resize")
                        .style("display", null);
                    g.select("#clip-" + id + " rect")
                        .attr("x", x(extent[0]))
                        .attr("width", x(extent[1]) - x(extent[0]));
                    dimension.filterRange(extent);
                    if (id === 0) { window.bar_catgory = extent }
                    else if (id === 1) { window.bar_age = extent }
                    else if (id === 2) { window.bar_country = extent }
                    else if (id === 3) {
                        window.bar_year = extent
                        update(extent[0], extent[1]-1, cat_filt, null)
                    };
                });

                brush.on("brushend.chart", function () {
                    if (brush.empty()) {
                        var div = d3.select(this.parentNode.parentNode.parentNode);
                        div.select(".title a").style("display", "none");
                        div.select("#clip-" + id + " rect").attr("x", null).attr("width", "100%");
                        dimension.filterAll();
                    }
                });

                chart.margin = function (_) {
                    if (!arguments.length) return margin;
                    margin = _;
                    return chart;
                };

                chart.x = function (_) {
                    if (!arguments.length) return x;
                    x = _;
                    axis.scale(x);
                    brush.x(x);
                    return chart;
                };

                chart.y = function (_) {
                    if (!arguments.length) return y;
                    y = _;
                    return chart;
                };

                chart.dimension = function (_) {
                    if (!arguments.length) return dimension;
                    dimension = _;
                    return chart;
                };

                chart.filter = function (_) {
                    if (_) {
                        brush.extent(_);
                        dimension.filterRange(_);
                    } else {
                        brush.clear();
                        dimension.filterAll();
                    }
                    brushDirty = true;
                    return chart;
                };

                chart.group = function (_) {
                    if (!arguments.length) return group;
                    group = _;
                    return chart;
                };

                chart.round = function (_) {
                    if (!arguments.length) return round;
                    round = _;
                    return chart;
                };

                return d3.rebind(chart, brush, "on");
            }

            // filter([[1, 7], [17, 91], [1, 31], [1901, 1917]]);

        });


        function draw(geo_data) {
            var margin = 5,
                width = 500 - margin,
                height = 340 - margin;

            // d3.select("body")
            //   .append("h2")
            //   .text("Nobel Prizes");

            var svg = d3.select("#map")
                .attr("width", width + margin)
                .attr("height", height + margin)
                .append('g')
                .attr('class', 'map');


            var projection = d3.geo.mercator()
                .scale(70)
                .translate([width / 2.2, height / 1.5]);

            var path = d3.geo.path().projection(projection);
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0.0);


            var map = svg.selectAll('path')
                .data(geo_data.features)
                .enter()
                .append('path')
                .attr('d', path)
                .style('fill', 'white')
                .style('stroke', null)
                .style('stroke-width', 0.5);

            svg.selectAll("text")
                .data(geo_data.features)
                .enter()
                .append("text")
                //设置各个文本（省份名称）显示的文字  
                .text(function (d) { return d.properties.name; })
                .attr("opacity", 0)
                .attr("font-size", 12)
                .attr("transform", function (d, i) {
                    if (d.properties.name == "USA") {
                        return "translate(" + (path.centroid(d)[0] + 20) + "," + (path.centroid(d)[1] + 20) + ")";
                    }
                    return "translate(" + (path.centroid(d)[0] - 10) + "," + path.centroid(d)[1] + ")";
                })
                .on("mouseover", function (d, i) {
                    d3.select(this)
                        .attr("opacity", 1);
                })
                .on("mouseout", function (d, i) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr("opacity", 0);
                });



            window.update = function (year1, year2, cat_filt, country_filt) {
                // console.log(country_filt)
                // console.log(country_filt==null, country_filt===null)
                d3.csv("data/nobel_map.csv", withdata);
                function withdata(data) {

                    var filtered = data.filter(function (d) {
                        return parseInt(d['Year']) >= parseInt(year1) &&
                            parseInt(d['Year']) <= parseInt(year2);

                    });

                    d3.select("h2")
                        .text("nobel " + year1 + '-' + year2);

                    var cat_countries = { "Chemistry": [], "Economics": [], "Literature": [], "Medicine": [], "Peace": [], "Physics": [] };


                    filtered.forEach(function (d) {
                        cat_countries[d['Category']].push(d['Birth Country']);
                    });

                    function update_countries(d) {

                        if ((cat_countries["Chemistry"].indexOf(d.properties.name) !== -1) && (cat_filt["Chemistry"] == 1)) {
                            return color("Chemistry");
                        } else if ((cat_countries["Peace"].indexOf(d.properties.name) !== -1) && (cat_filt["Peace"] == 1)) {
                            return color("Peace");
                        } else if ((cat_countries["Literature"].indexOf(d.properties.name) !== -1) && (cat_filt["Literature"] == 1)) {
                            return color("Literature");
                        } else if ((cat_countries["Medicine"].indexOf(d.properties.name) !== -1) && (cat_filt["Medicine"] == 1)) {
                            return color("Medicine");
                        } else if ((cat_countries["Physics"].indexOf(d.properties.name) !== -1) && (cat_filt["Physics"] == 1)) {
                            return color("Physics");
                        } else if ((cat_countries["Economics"].indexOf(d.properties.name) !== -1) && (cat_filt["Economics"] == 1)) {
                            return color("Economics");
                        } else {
                            return 'lightgrey';
                        }

                    }
                    svg.selectAll('path')
                        .transition()
                        .duration(500)
                        .attr('opacity', 0.5)
                        .style('fill', update_countries)
                        .style('stroke', update_countries);

                    var defs = svg.append('defs');
                    var arrowMarker = defs.append("marker")
                        .attr('id', 'arrow')
                        .attr('markerUnits', 'strokeWidth')
                        .attr('markerWidth', '5')
                        .attr('markerHeight', '5')
                        .attr('viewBox', '0 0 12 12')
                        .attr('refX', '6')
                        .attr('refY', '6')
                        .attr('orient', 'auto');
                    var arrow_path = "M2,2 L10,6 L2,10 L6,6 L2,2";

                    var cord = [];
                    geo_data.features.forEach(function (d, i) {
                        if (d.properties.name == 'USA')
                            cord.push({ 'country': d.properties.name, 'cordi': [path.centroid(d)[0] + 20, path.centroid(d)[1] + 20] });
                        //获取各个国家中心坐标

                        else
                            cord.push({ 'country': d.properties.name, 'cordi': [path.centroid(d)[0], path.centroid(d)[1]] });
                    });

                    var map = d3.map(cord, function (d) { return d.country; });

                    var defs = svg.append("defs");
                    var gaussian = defs.append("filter")
                        .attr("id", "gaussian");
                    gaussian.append("feGaussianBlur")
                        .attr("in", "SourceGraphic")
                        .attr("stdDeviation", "1");

                    var button = $('#mig_button')
                    if (button.css('color') === 'rgb(0, 0, 0)') {

                        svg.selectAll('line')
                            .remove();
                        svg.selectAll('circle')
                            .remove();

                        filtered.forEach(function (d, i) {

                            bc = filtered[i]["Birth Country"];
                            dc = filtered[i]["Death Country"];
                            if (dc === '') { dc = filtered[i]['Organization Country'] }
                            if (dc === '') { dc = bc }


                            if ((country_filt != null && (bc == country_filt || dc == country_filt)) || country_filt == null) {
                                if ((map.has(bc)) && (map.has(dc))) {
                                    bc_cordi = [map.get(bc)['cordi'][0] + Math.random() * 10, map.get(bc)['cordi'][1] + Math.random() * 10];
                                    dc_cordi = [map.get(dc)['cordi'][0] + Math.random() * 10, map.get(dc)['cordi'][1] + Math.random() * 10];

                                    svg.append('line')
                                        .attr('class', 'route')
                                        .attr('x1', bc_cordi[0])
                                        .attr('y1', bc_cordi[1])
                                        .attr('x2', dc_cordi[0])
                                        .attr('y2', dc_cordi[1])
                                        .attr("stroke", "grey")
                                        // .attr('stroke', 'url(#grad1)')
                                        .attr("stroke-width", 2)
                                        .attr("stroke-dasharray", "5,5")
                                        .attr('stroke-opacity', 0.3)

                                    svg.append('circle')
                                        .attr('class', 'point')
                                        .attr('cx', dc_cordi[0])
                                        .attr('cy', dc_cordi[1])
                                        .attr('r', 2)
                                        .style('fill', 'blue')
                                        .style('filter', "url(#" + gaussian.attr("id") + ")");

                                    svg.append('circle')
                                        .attr('class', 'point')
                                        .attr('cx', bc_cordi[0])
                                        .attr('cy', bc_cordi[1])
                                        .attr('r', 2)
                                        .style('fill', d3.rgb(0, 255, 255))
                                        .style('filter', "url(#" + gaussian.attr("id") + ")");


                                }

                                else {

                                    // console.log(bc);
                                    // console.log(dc);
                                }
                            }

                        })
                    }


                }


            }

            window.cat_filt = { "Chemistry": 1, "Economics": 1, "Literature": 1, "Medicine": 1, "Peace": 1, "Physics": 1 };
            update(1901, 1914, cat_filt, null);

        }
        d3.json("data/world_countries.json", draw);

        // var cat_filt={"Chemistry":1, "Economics":1, "Literature":1, "Medicine":1, "Peace":1, "Physics":1};  
        function catfun() {
            for (i = 0; i < cat_form.length; i++) {
                if (cat_form.elements[i].checked)
                    cat_filt[cat_form.elements[i].value] = 1;
                else
                    cat_filt[cat_form.elements[i].value] = 0;

            }
            if (typeof bar_year == 'undefined') {
                var start_year = $('#sankey_table').scrollLeft() / 94 + 1901,
                    end_year = start_year + 17;
            }
            else {
                var start_year = bar_year[0],
                    end_year = bar_year[1];
            }
            update(start_year, end_year, cat_filt, null);
        }

        function linefun() {
            var button = $('#mig_button')
            if (button.css('color') === 'rgb(0, 0, 0)') {
                var svg = d3.select('#map');
                svg.selectAll('line')
                    .remove();
                svg.selectAll('circle')
                    .remove();
                button.css('color', 'gray')
            }
            else {
                button.css('color', 'black')
                catfun()
            }
        }

        function year_filter(year) {
            filter([null, null, null, [year, year + 1]])
            update(year, year, cat_filt, null)
        }

        $('#sankey_table').on('scroll', function () {
            var start_year = $('#sankey_table').scrollLeft() / 94 + 1901,
                end_year = start_year + 1
            // end_year = start_year+(bar_year[1]-bar_year[0])
            filter([null, null, null, [start_year, end_year]]);
            update(start_year, start_year, cat_filt, null);
        });

        // $(document).ready(filter([[1, 7], [17, 91], [1, 17], [1901, 1917]]));


    </script>
    <style type="text/css">
        path:hover {
            stroke-opacity: 0.9;
        }

        ;
    </style>
    <style id="path_class">
        .mypath {
            stroke-opacity: 0.05;
            /* 描边透明度 */
        }
    </style>
    <style>
        #sankey_table {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 50px;
            overflow: auto;
        }

        #legend {
            margin-left: 10px;
        }

        #body {
            margin: 10px auto;
            width: 100%;
            min-height: 2000px;
            position: relative;
        }

        .chart {
            display: inline-block;
            height: 140px;
            margin-bottom: 20px;
            margin-left: 5px;
        }

        .reset {
            padding-left: 1em;
            font-size: smaller;
            color: #ccc;
        }

        .background.bar {
            fill: #ccc;
        }

        .foreground.bar {
            fill: brown;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .axis text {
            font: 10px sans-serif;
        }

        .brush rect.extent {
            fill: brown;
            fill-opacity: .125;
        }

        .brush .resize path {
            fill: #eee;
            stroke: #666;
        }

        div.title {
            font-weight: bold;
            height: 40px;
        }

        #category-chart {
            width: 60px;
        }

        #age-chart {
            width: 470px;
        }

        #country-chart {
            width: 210px;
        }

        #year-chart {
            width: 720px;
        }

        #lists {
            margin-left: 40px;
        }

        #nobel-list {
            min-height: 1024px;
        }

        #nobel-list .year,
        #nobel-list .y {
            margin-bottom: .4em;
        }

        #nobel-list .nl {
            line-height: 1.5em;
            background: #eee;
            width: 1300px;
            margin-bottom: 1px;
        }

        #nobel-list .id {
            color: #999;
        }

        #nobel-list .nl div {
            display: inline-block;
            width: 50px;
        }

        #nobel-list div.name {
            width: 200px;
        }

        #nobel-list div.category {
            width: 90px;
        }

        #nobel-list div.country {
            width: 120px;
        }

        #nobel-list div.gender {
            width: 70px;
        }

        #nobel-list div.motivation {
            width: 600px;
        }

        #nobel-list .early {
            color: green;
        }

        form {
            margin-left: 10px;
            margin-top: 80px;
        }

        aside {
            position: absolute;
            left: 620px;
            font-size: smaller;
            width: 220px;
        }

        #accordion {
            margin-top: 20px;
        }
    </style>

</body>

</html>